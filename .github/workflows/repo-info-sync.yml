name: Repo Info Sync

on:
  push:
    branches:
      - 'dev/**'

jobs:
  update-repo-info:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
          ref: ${{ github.ref }}

      - name: Generate repo info file
        id: write_repo_info
        shell: bash
        env:
          OWNER: ${{ github.repository_owner }}
          REPO_NAME: ${{ github.event.repository.name }}
          DEFAULT_BRANCH: ${{ github.event.repository.default_branch }}
          BRANCH_REF: ${{ github.ref }}
          ACTOR: ${{ github.actor }}
          COMMIT_SHA: ${{ github.sha }}
        run: |
          set -euo pipefail
          VERSION="unknown"
          if [[ "$BRANCH_REF" =~ ^refs/heads/dev/(v[0-9]+\.[0-9]+\.[0-9]+)$ ]]; then
            VERSION="${BASH_REMATCH[1]}"
          fi

          if [[ -z "${DEFAULT_BRANCH}" ]]; then
            DEFAULT_BRANCH="main"
          fi

          CURRENT_VERSION=""
          if [[ -f repo-info.yml ]]; then
            CURRENT_VERSION=$(awk 'BEGIN{found=0} /^release:/{found=1; next} found && /^  version:/ {print $2; exit}' repo-info.yml)
          fi

          if [[ "$CURRENT_VERSION" == "$VERSION" && "$VERSION" != "unknown" ]]; then
            echo "Existing repo-info.yml already reports version $VERSION; skipping update."
            echo "needs_commit=false" >> "$GITHUB_OUTPUT"
            echo "version=${VERSION}" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          GENERATED_AT="$(date -u +%Y-%m-%dT%H:%M:%SZ)"

          {
            printf "repository:\n"
            printf "  owner: %s\n" "$OWNER"
            printf "  name: %s\n" "$REPO_NAME"
            printf "  default_branch: %s\n" "$DEFAULT_BRANCH"
            printf "release:\n"
            printf "  base_branch: %s\n" "$DEFAULT_BRANCH"
            printf "  head_branch: %s\n" "${BRANCH_REF#refs/heads/}"
            printf "  version: %s\n" "$VERSION"
            printf "metadata:\n"
            printf "  generated_at: %s\n" "$GENERATED_AT"
            printf "  commit: %s\n" "$COMMIT_SHA"
          } > repo-info.yml

          STATUS="$(git status --short -- repo-info.yml 2>/dev/null || true)"
          if [[ -n "$STATUS" ]]; then
            echo "needs_commit=true" >> "$GITHUB_OUTPUT"
          else
            echo "needs_commit=false" >> "$GITHUB_OUTPUT"
          fi
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"

      - name: Commit repo info update
        if: steps.write_repo_info.outputs.needs_commit == 'true'
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore: sync repo info for ${{ steps.write_repo_info.outputs.version }}"
          file_pattern: repo-info.yml
