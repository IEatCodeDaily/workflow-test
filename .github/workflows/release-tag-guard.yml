name: Release Tag Guard

on:
  pull_request:
    types: [opened, reopened, synchronize, ready_for_review, edited]
    branches:
      - 'release/**'

jobs:
  release-branch-lock:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    env:
      RELEASE_GUARD_SHOULD_RUN: 'false'
      RELEASE_GUARD_VERSION: ''
      RELEASE_GUARD_PR_NUMBER: ''
      RELEASE_GUARD_TAG_EXISTS: 'false'

    steps:
      - name: Gather release metadata
        shell: bash
        run: |
          set -euo pipefail
          echo "RELEASE_GUARD_SHOULD_RUN=false" >> "$GITHUB_ENV"
          echo "RELEASE_GUARD_VERSION=" >> "$GITHUB_ENV"
          echo "RELEASE_GUARD_PR_NUMBER=" >> "$GITHUB_ENV"
          echo "RELEASE_GUARD_TAG_EXISTS=false" >> "$GITHUB_ENV"

          PR_STATE="${{ github.event.pull_request.state }}"
          BASE_BRANCH="${{ github.event.pull_request.base.ref }}"
          PR_NUMBER="${{ github.event.pull_request.number }}"

          if [[ "$PR_STATE" == "closed" ]]; then
            echo "Pull request already closed; skipping validation." >&2
            exit 0
          fi

          if [[ "$BASE_BRANCH" =~ ^release/(v[0-9]+\.[0-9]+\.[0-9]+)$ ]]; then
            VERSION="${BASH_REMATCH[1]}"
            echo "RELEASE_GUARD_SHOULD_RUN=true" >> "$GITHUB_ENV"
            echo "RELEASE_GUARD_VERSION=$VERSION" >> "$GITHUB_ENV"
            echo "RELEASE_GUARD_PR_NUMBER=$PR_NUMBER" >> "$GITHUB_ENV"
            echo "Detected release target branch $BASE_BRANCH with version $VERSION."
          else
            echo "Base branch $BASE_BRANCH does not match release pattern; skipping validation." >&2
          fi

      - name: Check if release tag exists
        if: ${{ env.RELEASE_GUARD_SHOULD_RUN == 'true' }}
        uses: actions/github-script@v7
        with:
          script: |
            const version = process.env.RELEASE_GUARD_VERSION;
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            try {
              await github.rest.git.getRef({ owner, repo, ref: `tags/${version}` });
              core.exportVariable('RELEASE_GUARD_TAG_EXISTS', 'true');
              core.info(`Tag ${version} already exists.`);
            } catch (error) {
              if (error.status === 404) {
                core.exportVariable('RELEASE_GUARD_TAG_EXISTS', 'false');
                core.info(`Tag ${version} is available.`);
              } else {
                throw error;
              }
            }

      - name: Warn and close pull request
        if: ${{ env.RELEASE_GUARD_SHOULD_RUN == 'true' && env.RELEASE_GUARD_TAG_EXISTS == 'true' }}
        uses: actions/github-script@v7
        with:
          script: |
            const version = process.env.RELEASE_GUARD_VERSION;
            const prNumber = Number(process.env.RELEASE_GUARD_PR_NUMBER);
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const warningMessage = `Release tag \`${version}\` already exists on this repository. This pull request is being closed to prevent changes to a locked release.`;

            const comments = await github.paginate(github.rest.issues.listComments, {
              owner,
              repo,
              issue_number: prNumber
            });

            const alreadyWarned = comments.some(comment => comment.body === warningMessage);

            if (!alreadyWarned) {
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: prNumber,
                body: warningMessage
              });
            }

            await github.rest.pulls.update({
              owner,
              repo,
              pull_number: prNumber,
              state: 'closed'
            });

            core.info(`Pull request #${prNumber} closed because tag ${version} already exists.`);

      - name: Fail job when release is locked
        if: ${{ env.RELEASE_GUARD_SHOULD_RUN == 'true' && env.RELEASE_GUARD_TAG_EXISTS == 'true' }}
        shell: bash
        run: |
          echo "Tag ${RELEASE_GUARD_VERSION} already exists; release branch is locked." >&2
          exit 1
