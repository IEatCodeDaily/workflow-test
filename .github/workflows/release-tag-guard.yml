name: Release Tag Guard

on:
  workflow_run:
    workflows: ['Repo Info Sync']
    types: [completed]

jobs:
  release-branch-lock:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    env:
      RELEASE_GUARD_SHOULD_RUN: 'false'
      RELEASE_GUARD_VERSION: ''
      RELEASE_GUARD_PR_NUMBER: ''
      RELEASE_GUARD_TAG_EXISTS: 'false'

    steps:
      - name: Extract release pull request context
        uses: actions/github-script@v7
        with:
          script: |
            const run = context.payload.workflow_run;

            if (!run) {
              core.info('No workflow run payload found; skipping.');
              return;
            }

            if (run.conclusion !== 'success') {
              core.info(`Upstream workflow concluded with status ${run.conclusion}; skipping guard.`);
              return;
            }

            const pr = run.pull_requests && run.pull_requests[0];
            if (!pr) {
              core.info('Workflow run is not associated with a pull request; skipping.');
              return;
            }

            if (pr.state === 'closed') {
              core.info('Pull request already closed; skipping guard.');
              return;
            }

            const baseRef = pr.base.ref;
            const match = baseRef.match(/^release\/(v[0-9]+\.[0-9]+\.[0-9]+)$/);
            if (!match) {
              core.info(`Base branch ${baseRef} is not a release branch; skipping guard.`);
              return;
            }

            core.exportVariable('RELEASE_GUARD_SHOULD_RUN', 'true');
            core.exportVariable('RELEASE_GUARD_VERSION', match[1]);
            core.exportVariable('RELEASE_GUARD_PR_NUMBER', String(pr.number));

      - name: Check if release tag exists
        if: ${{ env.RELEASE_GUARD_SHOULD_RUN == 'true' }}
        uses: actions/github-script@v7
        with:
          script: |
            const version = process.env.RELEASE_GUARD_VERSION;
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            try {
              await github.rest.git.getRef({ owner, repo, ref: `tags/${version}` });
              core.exportVariable('RELEASE_GUARD_TAG_EXISTS', 'true');
              core.info(`Tag ${version} already exists.`);
            } catch (error) {
              if (error.status === 404) {
                core.exportVariable('RELEASE_GUARD_TAG_EXISTS', 'false');
                core.info(`Tag ${version} is available.`);
              } else {
                throw error;
              }
            }

      - name: Warn and close pull request
        if: ${{ env.RELEASE_GUARD_SHOULD_RUN == 'true' && env.RELEASE_GUARD_TAG_EXISTS == 'true' }}
        uses: actions/github-script@v7
        with:
          script: |
            const version = process.env.RELEASE_GUARD_VERSION;
            const prNumber = Number(process.env.RELEASE_GUARD_PR_NUMBER);
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const warningMessage = `Release tag \`${version}\` already exists on this repository. This pull request is being closed to prevent changes to a locked release.`;

            const comments = await github.paginate(github.rest.issues.listComments, {
              owner,
              repo,
              issue_number: prNumber
            });

            const alreadyWarned = comments.some(comment => comment.body === warningMessage);

            if (!alreadyWarned) {
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: prNumber,
                body: warningMessage
              });
            }

            await github.rest.pulls.update({
              owner,
              repo,
              pull_number: prNumber,
              state: 'closed'
            });

            core.info(`Pull request #${prNumber} closed because tag ${version} already exists.`);

      - name: Fail job when release is locked
        if: ${{ env.RELEASE_GUARD_SHOULD_RUN == 'true' && env.RELEASE_GUARD_TAG_EXISTS == 'true' }}
        shell: bash
        run: |
          echo "Tag ${RELEASE_GUARD_VERSION} already exists; release branch is locked." >&2
          exit 1
